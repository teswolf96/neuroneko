{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Chat Interface{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    {% block extra_head %}{% endblock %}
</head>
<body class="bg-gray-900 text-white h-screen flex">

    <!-- Sidebar -->
    <aside class="w-64 bg-gray-800 p-4 flex flex-col">
        <button class="bg-gray-700 text-white px-4 py-2 rounded mb-4">+ New Chat</button>

        <div class="flex-1 overflow-y-auto"> <!-- Added overflow-y-auto for scrollable chat list -->
            {% for item in folder_structure %}
                {% if item.name != "Other Chats" or item.chats %} <!-- Show folder or "Other Chats" if it has chats -->
                    <h2 class="text-sm font-bold text-gray-400 mt-4 mb-2 px-2">{{ item.name }}</h2>
                    {% if item.chats %}
                        <ul class="space-y-1">
                            {% for chat in item.chats %}
                                <li class="text-white py-1 hover:bg-gray-700 rounded px-2 text-sm chat-item">
                                    {# Placeholder link - replace with actual chat URL later if needed #}
                                    {# e.g., <a href="{% url 'chat_view' chat.id %}"> #}
                                    <a href="#" class="chat-link block w-full h-full" data-chat-id="{{ chat.id }}">{{ chat.title|truncatechars:25 }}</a> 
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        {% if item.name != "Other Chats" %} <!-- Don't show "No chats here" for the general "Other Chats" if it's empty by design -->
                            <p class="text-xs text-gray-500 ml-2 px-2">No chats in this folder.</p>
                        {% endif %}
                    {% endif %}
                {% endif %}
            {% endfor %}
        </div>

        <div class="space-y-2 mt-4">
            <button class="text-sm text-gray-400 flex items-center">Hello, {{ user.username }}!</button>
            <button class="text-sm text-gray-400 flex">Manage Tags</button>
            <button class="text-sm text-gray-400 flex">Import / Export</button>
            <button class="text-sm text-gray-400 flex">API</button>
            <a href="{% url 'user_settings' %}" class="text-sm text-gray-400 flex">Settings</a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-1 flex flex-col h-screen"> <!-- Added flex flex-col h-screen for layout -->
        {% block content %}
        <div class="bg-gray-800 p-4 rounded"> <!-- Added mb-4 for spacing -->
            <div class="flex items-center justify-between text-sm mb-2">
                <span>Model: <span id="chat-model-name">claude-3-7-sonnet-20250219</span></span>
                <span>Max Output: 64000</span>
                <span>Temperature: <span id="chat-model-temp">0.8</span></span>
                <!-- <span>Top-p: 1</span>
                <span>Presence Penalty: 0</span>
                <span>Frequency Penalty: 0</span> -->
            </div>

            <!-- <div class="bg-gray-700 p-4 rounded mb-4">
                <span class="text-sm">System</span>
                <p id="chat-system-prompt">You are playing the role of a friendly and helpful chatbot.</p>
            </div> -->
        </div> <!-- Moved closing div for settings/system prompt block -->

        <!-- Chat Messages Area -->
        <div id="chat-messages-container" class="flex-grow overflow-y-auto bg-gray-750 p-4 rounded mb-4 space-y-2">
            <p class="text-gray-500">Select a chat to view messages.</p> 
        </div>

        <!-- Input Area -->
        <div class="bg-gray-800 p-4 rounded mt-auto"> <!-- mt-auto to push to bottom -->
            <div class="bg-gray-700 p-4 rounded flex items-start space-x-2">
                <div class="bg-red-500 px-2 py-1 rounded">User</div>
                <textarea class="w-full bg-gray-800 p-2 rounded text-white" rows="4" placeholder="Type a message or click / for prompts..."></textarea>
                <!-- Button column for Generate, Save, Prompt, Idea -->
                <div class="flex flex-col space-y-1">
                    <button class="bg-green-500 px-4 py-2 rounded w-full">Generate</button>
                    <button class="bg-gray-600 px-4 py-2 rounded w-full">Save</button>
                    <div class="flex space-x-1 mt-1">
                        <button class="bg-gray-600 px-3 py-1 rounded text-xs flex-grow">Prompt</button>
                        <button class="bg-gray-600 px-3 py-1 rounded text-xs flex-grow">Idea</button>
                    </div>
                </div>
            </div>
            <!-- The div that previously held Prompt and Idea buttons is removed by not including it here -->
            <div class="flex space-x-2 mt-4">
                <button class="bg-gray-700 px-3 py-1 rounded">Regen Title</button>
                <button class="bg-gray-700 px-3 py-1 rounded">Download Chat</button>
                <button class="bg-gray-700 px-3 py-1 rounded">Clone Chat</button>
                <button class="bg-gray-700 px-3 py-1 rounded">Continue</button>
            </div>
        </div> <!-- Closing div for input area -->
        {% endblock %}
    </main>
    {% block extra_js %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const chatItems = document.querySelectorAll('.chat-item');
            const chatModelNameEl = document.getElementById('chat-model-name');
            const chatModelTempEl = document.getElementById('chat-model-temp');
            const chatSystemPromptEl = document.getElementById('chat-system-prompt');
            const chatMessagesContainerEl = document.getElementById('chat-messages-container');
            const messageInputTextarea = document.querySelector('textarea[placeholder="Type a message or click / for prompts..."]');
            const saveButton = document.querySelector('button.bg-gray-600.px-4.py-2.rounded.w-full'); // More specific selector if needed

            let currentActiveChatLi = null;
            let currentChatId = null; // To store the ID of the currently active chat
            const lastActiveChatIdFromDjango = '{{ last_active_chat_id|default_if_none:"" }}';

            // Function to render a single message
            function renderMessage(msg, container, showPlusIcon) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('p-3', 'rounded-lg', 'break-words', 'mb-2', 'relative'); // Added relative for icon positioning
                messageDiv.setAttribute('data-message-id', msg.id);

                // Role Dropdown
                const roleSelect = document.createElement('select');
                roleSelect.classList.add('bg-gray-500', 'text-white', 'text-xs', 'font-semibold', 'rounded', 'p-1', 'mb-1', 'mr-2', 'focus:outline-none', 'focus:ring-1', 'focus:ring-blue-400');
                const roles = ['User', 'Assistant', 'System'];
                roles.forEach(r => {
                    const option = document.createElement('option');
                    option.value = r.toLowerCase();
                    option.textContent = r;
                    if (msg.role && msg.role.toLowerCase() === r.toLowerCase()) {
                        option.selected = true;
                    } else if (!msg.role && r.toLowerCase() === 'assistant') { // Default to assistant if role is missing
                        option.selected = true;
                    }
                    roleSelect.appendChild(option);
                });

                const contentP = document.createElement('p');
                contentP.classList.add('text-sm');
                contentP.textContent = msg.content;

                if (msg.role === 'user') {
                    messageDiv.classList.add('bg-indigo-500', 'ml-auto', 'text-white');
                    roleSelect.classList.remove('bg-gray-500', 'text-white');
                    roleSelect.classList.add('bg-indigo-400', 'text-indigo-100');
                } else { // assistant or system roles
                    messageDiv.classList.add('bg-gray-600', 'mr-auto', 'text-gray-100');
                }

                messageDiv.appendChild(roleSelect);
                messageDiv.appendChild(contentP);

                // Footer for icons
                const footerDiv = document.createElement('div');
                footerDiv.classList.add('relative', 'h-5', 'mt-1'); // Height to contain icons, mt-1 for spacing

                // Action Icons (Copy, Edit, Delete) - bottom-right
                const iconsDiv = document.createElement('div');
                iconsDiv.classList.add('absolute', 'bottom-0', 'right-0', 'flex', 'space-x-2');

                const copyButton = document.createElement('button');
                copyButton.innerHTML = 'ðŸ“„'; // Unicode for Copy
                copyButton.title = 'Copy';
                copyButton.classList.add('text-xs', 'hover:text-gray-300', 'focus:outline-none');

                const editButton = document.createElement('button');
                editButton.innerHTML = 'âœï¸'; // Unicode for Edit
                editButton.title = 'Edit';
                editButton.classList.add('text-xs', 'hover:text-gray-300', 'focus:outline-none');

                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = 'ðŸ—‘ï¸'; // Unicode for Delete
                deleteButton.title = 'Delete';
                deleteButton.classList.add('text-xs', 'hover:text-gray-300', 'focus:outline-none');

                iconsDiv.appendChild(copyButton);
                iconsDiv.appendChild(editButton);
                iconsDiv.appendChild(deleteButton);
                footerDiv.appendChild(iconsDiv);

                // Plus Icon (bottom-center, conditional)
                if (showPlusIcon) {
                    const plusButtonDiv = document.createElement('div');
                    plusButtonDiv.classList.add('absolute', 'bottom-0', 'left-1/2', '-translate-x-1/2');

                    const plusButton = document.createElement('button');
                    plusButton.innerHTML = 'âž•'; // Unicode for Plus
                    plusButton.title = 'Add message below';
                    plusButton.classList.add('bg-gray-500', 'text-white', 'rounded-full', 'w-5', 'h-5', 'flex', 'items-center', 'justify-center', 'text-xs', 'hover:bg-gray-400', 'focus:outline-none');
                    plusButtonDiv.appendChild(plusButton);
                    footerDiv.appendChild(plusButtonDiv);
                }

                messageDiv.appendChild(footerDiv);
                container.appendChild(messageDiv);
            }

            // Function to render message tree
            function renderMessageTree(nodes, container) {
                nodes.forEach((node, index) => {
                    let showPlus = false;
                    // Show plus if it has children OR if it's not the last direct sibling
                    if ((node.children && node.children.length > 0) || index < nodes.length - 1) {
                        showPlus = true;
                    }
                    renderMessage(node, container, showPlus);

                    if (node.children && node.children.length > 0) {
                        // Render children directly into the main container without extra div or indentation classes
                        renderMessageTree(node.children, container);
                    }
                });
            }


            chatItems.forEach(item => {
                item.addEventListener('click', function (event) {
                    event.preventDefault();
                    const chatLink = this.querySelector('.chat-link');
                    if (!chatLink) return;

                    const chatIdFromLink = chatLink.dataset.chatId;
                    if (!chatIdFromLink) return;

                    currentChatId = chatIdFromLink; // Store the active chat ID

                    if (currentActiveChatLi) {
                        currentActiveChatLi.classList.remove('bg-blue-600', 'text-white'); // Example active class
                        currentActiveChatLi.classList.add('hover:bg-gray-700');
                    }
                    this.classList.add('bg-blue-600', 'text-white');
                    this.classList.remove('hover:bg-gray-700');
                    currentActiveChatLi = this;

                    fetch(`/api/chat/${currentChatId}/`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log("Chat details:", data);
                            chatModelNameEl.textContent = data.ai_model_name || 'N/A';
                            chatModelTempEl.textContent = data.temperature || 'N/A';
                            // chatSystemPromptEl.textContent = data.system_prompt || 'No system prompt set.';
                            
                            chatMessagesContainerEl.innerHTML = ''; // Clear previous messages
                            if (data.messages && data.messages.length > 0) {
                                renderMessageTree(data.messages, chatMessagesContainerEl);
                            } else {
                                chatMessagesContainerEl.innerHTML = '<p class="text-gray-500 p-4">No messages in this chat yet.</p>';
                            }
                            chatMessagesContainerEl.scrollTop = chatMessagesContainerEl.scrollHeight;
                        })
                        .catch(error => {
                            console.error('Error fetching chat details:', error);
                            chatMessagesContainerEl.innerHTML = '<p class="text-red-400 p-4">Error loading chat. Please try again.</p>';
                            if (currentActiveChatLi) {
                                currentActiveChatLi.classList.remove('bg-blue-600', 'text-white');
                                currentActiveChatLi.classList.add('hover:bg-gray-700');
                            }
                        });
                });
            });

            // Automatically click the last active chat if it exists
            if (lastActiveChatIdFromDjango && lastActiveChatIdFromDjango !== '') {
                currentChatId = lastActiveChatIdFromDjango; // Set currentChatId if loading last active
                const targetChatLink = document.querySelector(`.chat-link[data-chat-id="${lastActiveChatIdFromDjango}"]`);
                if (targetChatLink) {
                    const targetChatItem = targetChatLink.closest('.chat-item');
                    if (targetChatItem) {
                        targetChatItem.click(); 
                    } else {
                        console.warn(`Could not find .chat-item for chat ID: ${lastActiveChatIdFromDjango}`);
                    }
                } else {
                    console.warn(`Could not find .chat-link for chat ID: ${lastActiveChatIdFromDjango}`);
                }
            }

            // Save button functionality
            if (saveButton) {
                saveButton.addEventListener('click', function() {
                    const messageContent = messageInputTextarea.value.trim();
                    if (!messageContent) {
                        alert('Please type a message to save.');
                        return;
                    }
                    if (!currentChatId) {
                        alert('Please select a chat first.');
                        return;
                    }

                    // Find the newest message ID in the current chat display to use as parent
                    const allMessageElements = chatMessagesContainerEl.querySelectorAll('[data-message-id]');
                    let parentMessageId = null;
                    if (allMessageElements.length > 0) {
                        parentMessageId = allMessageElements[allMessageElements.length - 1].dataset.messageId;
                    } else {
                        // This case should ideally be handled by ensuring the root message exists and is loaded.
                        // If there are truly no messages, the backend might need to handle creating a root message
                        // or the first message if parent_message_id is null.
                        // For now, we'll proceed, and the backend will require a parent_message_id.
                        // This implies the first message (assistant's welcome) should have an ID.
                        console.warn("No messages found in container to set as parent. The backend might require a root message to exist.");
                        // If the chat is truly empty and the backend expects a root, this will fail.
                        // The backend logic currently requires a parent_message_id.
                        // A robust solution would be for get_chat_details to always return at least the root message if it exists.
                        // And if the chat is brand new and empty, the first "saved" message might become the root.
                        // This specific task is "add a new child message to the newest child Message", so a parent is implied.
                        alert('Cannot save message: No parent message found in the current chat display.');
                        return;
                    }
                     if (!parentMessageId) {
                        alert('Cannot determine the parent message ID.');
                        return;
                    }


                    fetch(`/api/chat/${currentChatId}/add_message/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}' // Ensure CSRF token is available and correct
                        },
                        body: JSON.stringify({
                            message_content: messageContent,
                            parent_message_id: parentMessageId
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => { throw new Error(err.error || `HTTP error! status: ${response.status}`) });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'success' && data.message) {
                            // Append the new message to the UI
                            // A newly added message is last and has no children yet, so showPlusIcon is false.
                            renderMessage(data.message, chatMessagesContainerEl, false);
                            chatMessagesContainerEl.scrollTop = chatMessagesContainerEl.scrollHeight;
                            messageInputTextarea.value = ''; // Clear textarea
                        } else {
                            alert('Error saving message: ' + (data.error || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        console.error('Error saving message:', error);
                        alert('Error saving message: ' + error.message);
                    });
                });
            } else {
                console.warn("Save button not found.");
            }
        });
    </script>
    {% endblock %}
</body>
</html>
